## RPCを作成して感じていたこととその疑問

### 結局APIサーバーと処理が似ててAPIサーバーで良くないか？RPCの方がいいときはどんなとき？

- プロトコル（例: gRPC、Thrift、XML-RPCなど）によって効率的にデータを転送する仕組みが組み込まれています。バイナリ形式でデータがやり取りされることが多く、APIの一般的なREST/JSON形式に比べて通信量やパフォーマンスの点で効率的
  - サンプルのclient.jsとserver.pyの通信では独自の単純なTCPソケット通信を用いて、JSON形式で送受信するプロトコル。これをバイナリ形式でやり取りする方法もある。
- クライアントとサーバーの密な統合
  - RPCは、関数やメソッドの呼び出しという形でやり取りをするため、クライアントとサーバーが密に連携しやすい設計です。通常、クライアント用のライブラリが提供され、サーバー側のメソッド呼び出しがそのままクライアントに反映されるため、クライアントはサーバーの仕様を意識せずに関数呼び出しを行えます。
  - 上記は拡張性の観点でデメリットでは？
  - いや、下記のメリットがあるらしい
    - 高速通信:密結合により、通信プロトコルやデータのシリアライズ形式が最適化できるため、データ転送が高速になります。たとえば、gRPCやThriftのようにバイナリ形式を用いることで、データサイズが小さくなり、ネットワーク通信が効率化します。
    - 開発効率向上；RPCはリモートの関数をローカルの関数のように呼び出せるため、クライアントとサーバーの実装がシンプルになります。コードの自動生成や型安全な通信が可能になるため、開発とメンテナンスの効率が上がります。
      - たしかに、NextJS13の開発体験は良い。
- RPCは通常、双方向の通信やストリーミングもサポート
- マイクロサービス間の通信に適している
　　- スキーマベースのRPCでは、スキーマファイルや型安全のコード自動生成でスキーマ（データ構造の設計図）に基づいて厳格に定義している
   - RPCのスキーマは、クライアントとサーバー間での**共通の基点（約束事）**となり、お互いがそのスキーマに基づいて通信を行います。あとは双方独自に実装を進めていける。
   - RPCスキーマのコードのサンプル例.protoファイル
     ```
        syntax = "proto3";
        service Calculator {
        rpc Add (AddRequest) returns (AddResponse);
        }

        message AddRequest {
        int32 a = 1;
        int32 b = 2;
        }

        message AddResponse {
        int32 result = 1;
        }
     ```
- 一般論でいいのだけど、どのくらい定量的なメリットがあるの？
  - レイテンシ（応答時間）：RestAPIと比べて20-50%のレイテンシが見込める
    - gRPC利用では、特にHTTP/2のマルチプレクシング機能により、1つの接続上で複数のリクエストとレスポンスが並列に処理されるため。
  - 同時リクエスト数（スループット）：特に1000リクエスト/秒以上の大量のリクエストを扱う場合でも、サーバーリソースを効率的に使用できることが多いです。REST APIに比べて1.5倍から2倍のスループット向上。
  - 背景のCPU使用率とメモリ効率
    - バイナリ形式でのデータシリアライズとデシリアライズはCPU負荷が低い
    - 特に小規模データの大量のリクエストが頻発するシステムでは、リソース効率が高くなるケースが多い